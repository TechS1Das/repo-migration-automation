- name: Process Repository List
  env:
    GH_PAT: ${{ secrets.GH_PAT }}
    REPO_LIST: ${{ github.event.inputs.repo_list }}
    TARGET_USER: ${{ github.repository_owner }}
  run: |

    echo "$REPO_LIST" | while IFS=',' read -r SOURCE_URL NEW_NAME
    do
      echo "======================================="
      echo "Cloning from: $SOURCE_URL"
      echo "New repo name: $NEW_NAME"

      REPO_DIR=$(basename -s .git $SOURCE_URL)

      # Clone as bare repo (safer than mirror in CI)
      git clone --bare $SOURCE_URL
      cd $REPO_DIR.git

      echo "Creating repository $NEW_NAME"

      curl -s -X POST https://api.github.com/user/repos \
        -H "Authorization: token $GH_PAT" \
        -H "Accept: application/vnd.github+json" \
        -d "{\"name\":\"$NEW_NAME\",\"private\":false}" \
        > /dev/null

      echo "Setting new remote..."

      git remote remove origin
      git remote add origin https://$GH_PAT@github.com/$TARGET_USER/$NEW_NAME.git

      echo "Pushing branches..."
      git push --all

      echo "Pushing tags..."
      git push --tags

      cd ..
      rm -rf $REPO_DIR.git

      echo "Completed $NEW_NAME"
      echo "======================================="

    done
