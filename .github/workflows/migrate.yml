name: Dynamic Repo Migration

on:
  workflow_dispatch:
    inputs:
      repo_list:
        description: "Enter repos in format: SOURCE_URL,NEW_NAME (one per line)"
        required: true
        type: string

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Migrate Repositories
        shell: bash
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          REPO_LIST: ${{ github.event.inputs.repo_list }}
          TARGET_USER: ${{ github.repository_owner }}
        run: |

          set -e

          echo "Starting migration..."

          # Convert input to proper newline handling
          echo "$REPO_LIST" > repos.txt

          while IFS=',' read -r SOURCE_URL NEW_NAME
          do
            echo "--------------------------------------"
            echo "Source: $SOURCE_URL"
            echo "New Repo: $NEW_NAME"

            REPO_DIR=$(basename "$SOURCE_URL" .git)

            # Clone as bare repo
            git clone --bare "$SOURCE_URL"
            cd "$REPO_DIR.git"

            echo "Creating new repository..."

            curl -s -X POST \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/user/repos \
              -d "{\"name\":\"$NEW_NAME\",\"private\":false}" \
              > /dev/null

            # Set new remote
            git remote remove origin
            git remote add origin "https://$GH_PAT@github.com/$TARGET_USER/$NEW_NAME.git"

            echo "Pushing branches..."
            git push --all

            echo "Pushing tags..."
            git push --tags

            cd ..
            rm -rf "$REPO_DIR.git"

            echo "Completed $NEW_NAME"
            echo "--------------------------------------"

          done < repos.txt

          echo "Migration completed."
